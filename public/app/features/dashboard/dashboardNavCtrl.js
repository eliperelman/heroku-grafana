/*! grafana - v2.6.0 - 2015-12-14
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","vendor/filesaver"],function(a,b){"use strict";var c=a.module("grafana.controllers");c.controller("DashboardNavCtrl",["$scope","$rootScope","alertSrv","$location","playlistSrv","backendSrv","$timeout",function(c,d,e,f,g,h,i){c.init=function(){c.onAppEvent("save-dashboard",c.saveDashboard),c.onAppEvent("delete-dashboard",c.deleteDashboard)},c.openEditView=function(a){var c=b.extend(f.search(),{editview:a});f.search(c)},c.starDashboard=function(){c.dashboardMeta.isStarred?h["delete"]("/api/user/stars/dashboard/"+c.dashboard.id).then(function(){c.dashboardMeta.isStarred=!1}):h.post("/api/user/stars/dashboard/"+c.dashboard.id).then(function(){c.dashboardMeta.isStarred=!0})},c.shareDashboard=function(){c.appEvent("show-modal",{src:"./app/features/dashboard/partials/shareModal.html",scope:c.$new()})},c.openSearch=function(){c.appEvent("show-dash-search")},c.hideTooltip=function(b){a.element(b.currentTarget).tooltip("hide"),c.appEvent("hide-dash-search")},c.saveDashboard=function(a){if(c.dashboardMeta.canSave!==!1){var b=c.dashboard.getSaveModelClone();h.saveDashboard(b,a).then(function(a){c.dashboard.version=a.version,c.appEvent("dashboard-saved",c.dashboard);var d="/dashboard/db/"+a.slug;d!==f.path()&&f.url(d),c.appEvent("alert-success",["Dashboard saved","Saved as "+b.title])},c.handleSaveDashError)}},c.handleSaveDashError=function(a){a.data&&"version-mismatch"===a.data.status&&(a.isHandled=!0,c.appEvent("confirm-modal",{title:"Someone else has updated this dashboard!",text:"Would you still like to save this dashboard?",yesText:"Save & Overwrite",icon:"fa-warning",onConfirm:function(){c.saveDashboard({overwrite:!0})}})),a.data&&"name-exists"===a.data.status&&(a.isHandled=!0,c.appEvent("confirm-modal",{title:"Another dashboard with the same name exists",text:"Would you still like to save this dashboard?",yesText:"Save & Overwrite",icon:"fa-warning",onConfirm:function(){c.saveDashboard({overwrite:!0})}}))},c.deleteDashboard=function(){c.appEvent("confirm-modal",{title:"Do you want to delete dashboard "+c.dashboard.title+"?",icon:"fa-trash",yesText:"Delete",onConfirm:function(){c.deleteDashboardConfirmed()}})},c.deleteDashboardConfirmed=function(){h["delete"]("/api/dashboards/db/"+c.dashboardMeta.slug).then(function(){c.appEvent("alert-success",["Dashboard Deleted",c.dashboard.title+" has been deleted"]),f.url("/")})},c.saveDashboardAs=function(){var a=d.$new();a.clone=c.dashboard.getSaveModelClone(),a.clone.editable=!0,a.clone.hideControls=!1,c.appEvent("show-modal",{src:"./app/features/dashboard/partials/saveDashboardAs.html",scope:a})},c.exportDashboard=function(){var b=c.dashboard.getSaveModelClone(),d=new Blob([a.toJson(b,!0)],{type:"application/json;charset=utf-8"});window.saveAs(d,c.dashboard.title+"-"+(new Date).getTime())},c.snapshot=function(){c.dashboard.snapshot=!0,d.$broadcast("refresh"),i(function(){c.exportDashboard(),c.dashboard.snapshot=!1,c.appEvent("dashboard-snapshot-cleanup")},1e3)},c.editJson=function(){var a=c.dashboard.getSaveModelClone();c.appEvent("show-json-editor",{object:a})},c.stopPlaylist=function(){g.stop(1)}}])});