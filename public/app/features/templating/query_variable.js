/*! grafana - v4.0.0-1478693311beta1 - 2016-11-09
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["lodash","app/core/utils/kbn","./variable"],function(a){function b(){return{text:"None",value:"",isNone:!0}}var c,d,e,f;return{setters:[function(a){c=a},function(a){d=a},function(a){e=a}],execute:function(){f=function(){function a(a,b,c,d,f){this.model=a,this.datasourceSrv=b,this.templateSrv=c,this.variableSrv=d,this.$q=f,this.defaults={type:"query",label:null,query:"",regex:"",sort:0,datasource:null,refresh:0,hide:0,name:"",multi:!1,includeAll:!1,allValue:null,options:[],current:{},tagsQuery:null,tagValuesQuery:null},e.assignModelProperties(this,a,this.defaults)}return a.$inject=["model","datasourceSrv","templateSrv","variableSrv","$q"],a.prototype.getModel=function(){return e.assignModelProperties(this.model,this,this.defaults),this.model},a.prototype.setValue=function(a){return this.variableSrv.setOptionAsCurrent(this,a)},a.prototype.setValueFromUrl=function(a){return this.variableSrv.setOptionFromUrl(this,a)},a.prototype.getValueForUrl=function(){return"All"===this.current.text?"All":this.current.value},a.prototype.updateOptions=function(){return this.datasourceSrv.get(this.datasource).then(this.updateOptionsFromMetricFindQuery.bind(this)).then(this.variableSrv.validateVariableSelectionState.bind(this.variableSrv,this))},a.prototype.updateOptionsFromMetricFindQuery=function(a){var c=this;return a.metricFindQuery(this.query).then(function(d){return c.options=c.metricNamesToVariableValues(d),c.includeAll&&c.addAllOption(),c.options.length||c.options.push(b()),a})},a.prototype.addAllOption=function(){this.options.unshift({text:"All",value:"$__all"})},a.prototype.metricNamesToVariableValues=function(a){var b,e,f,g;for(e=[],this.regex&&(b=d["default"].stringToJsRegex(this.templateSrv.replace(this.regex))),f=0;f<a.length;f++){var h=a[f],i=h.value||h.text,j=h.text||h.value;if(c["default"].isNumber(i)&&(i=i.toString()),c["default"].isNumber(j)&&(j=j.toString()),b){if(g=b.exec(i),!g)continue;g.length>1&&(i=g[1],j=g[1])}e.push({text:j,value:i})}return e=c["default"].uniqBy(e,"value"),this.sortVariableValues(e,this.sort)},a.prototype.sortVariableValues=function(a,b){if(0===b)return a;var d=Math.ceil(b/2),e=b%2===0;return 1===d?a=c["default"].sortBy(a,"text"):2===d&&(a=c["default"].sortBy(a,function(a){var b=a.text.match(/.*?(\d+).*/);return b?parseInt(b[1],10):0})),e&&(a=a.reverse()),a},a.prototype.dependsOn=function(a){return e.containsVariable(this.query,this.datasource,a.name)},a}(),a("QueryVariable",f),e.variableTypes.query={name:"Query",ctor:f,description:"Variable values are fetched from a datasource query",supportsMulti:!0}}}});