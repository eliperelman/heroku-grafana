/*! grafana - v4.0.0-1478693311beta1 - 2016-11-09
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["lodash","app/core/core_module","./variable"],function(a){var b,c,d,e;return{setters:[function(a){b=a},function(a){c=a},function(a){d=a}],execute:function(){e=function(){function a(a,c,e,f){this.$scope=a,this.datasourceSrv=c,this.variableSrv=e,a.variableTypes=d.variableTypes,a.ctrl={},a.refreshOptions=[{value:0,text:"Never"},{value:1,text:"On Dashboard Load"},{value:2,text:"On Time Range Change"}],a.sortOptions=[{value:0,text:"Disabled"},{value:1,text:"Alphabetical (asc)"},{value:2,text:"Alphabetical (desc)"},{value:3,text:"Numerical (asc)"},{value:4,text:"Numerical (desc)"}],a.hideOptions=[{value:0,text:""},{value:1,text:"Label"},{value:2,text:"Variable"}],a.init=function(){a.mode="list",a.datasources=b["default"].filter(c.getMetricSources(),function(a){return!a.meta.builtIn&&null!==a.value}),a.datasourceTypes=b["default"](a.datasources).uniqBy("meta.id").map(function(a){return{text:a.meta.name,value:a.meta.id}}).value(),a.variables=e.variables,a.reset(),a.$watch("mode",function(b){"new"===b&&a.reset()})},a.add=function(){a.isValid()&&(a.variables.push(a.current),a.update(),a.dashboard.updateSubmenuVisibility())},a.isValid=function(){if(a.ctrl.form.$valid){if(!a.current.name.match(/^\w+$/))return a.appEvent("alert-warning",["Validation","Only word and digit characters are allowed in variable names"]),!1;var c=b["default"].find(a.variables,{name:a.current.name});return!c||c===a.current||(a.appEvent("alert-warning",["Validation","Variable with the same name already exists"]),!1)}},a.validate=function(){a.infoText="","adhoc"===a.current.type&&null!==a.current.datasource&&(a.infoText="Adhoc filters are applied automatically to all queries that target this datasource",c.get(a.current.datasource).then(function(b){b.getTagKeys||(a.infoText="This datasource does not support adhoc filters yet.")}))},a.runQuery=function(){return e.updateOptions(a.current).then(null,function(b){b.data&&b.data.message&&(b.message=b.data.message),a.appEvent("alert-error",["Templating","Template variables could not be initialized: "+b.message])})},a.edit=function(b){a.current=b,a.currentIsNew=!1,a.mode="edit",a.validate()},a.duplicate=function(c){var d=b["default"].cloneDeep(c.getModel());a.current=e.createVariableFromModel(d),a.variables.push(a.current),a.current.name="copy_of_"+c.name,a.dashboard.updateSubmenuVisibility()},a.update=function(){a.isValid()&&a.runQuery().then(function(){a.reset(),a.mode="list",f.updateTemplateData()})},a.reset=function(){a.currentIsNew=!0,a.current=e.createVariableFromModel({type:"query"})},a.typeChanged=function(){var c=a.current;a.current=e.createVariableFromModel({type:a.current.type}),a.current.name=c.name,a.current.hide=c.hide,a.current.label=c.label;var d=b["default"].indexOf(this.variables,c);d!==-1&&(this.variables[d]=a.current),a.validate()},a.removeVariable=function(c){var d=b["default"].indexOf(a.variables,c);a.variables.splice(d,1),a.dashboard.updateSubmenuVisibility()}}return a.$inject=["$scope","datasourceSrv","variableSrv","templateSrv"],a}(),a("VariableEditorCtrl",e),c["default"].controller("VariableEditorCtrl",e)}}});