/*! grafana - v2.6.0 - 2015-12-14
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","app/app","lodash","app/core/utils/kbn","app/core/time_series","app/features/panel/panel_meta","./singleStatPanel"],function(a,b,c,d,e,f){"use strict";var g=a.module("grafana.panels.singlestat");b.useModule(g),g.directive("grafanaPanelSinglestat",function(){return{controller:"SingleStatCtrl",templateUrl:"app/panels/singlestat/module.html"}}),g.controller("SingleStatCtrl",["$scope","panelSrv","panelHelper",function(a,b,g){a.panelMeta=new f({panelName:"Singlestat",editIcon:"fa fa-dashboard",fullscreen:!0,metricsEditor:!0}),a.fontSizes=["20%","30%","50%","70%","80%","100%","110%","120%","150%","170%","200%"],a.panelMeta.addEditorTab("Options","app/panels/singlestat/editor.html"),a.panelMeta.addEditorTab("Time range","app/features/panel/partials/panelTime.html");var h={links:[],datasource:null,maxDataPoints:100,interval:null,targets:[{}],cacheTimeout:null,format:"none",prefix:"",postfix:"",nullText:null,valueMaps:[{value:"null",op:"=",text:"N/A"}],nullPointMode:"connected",valueName:"avg",prefixFontSize:"50%",valueFontSize:"80%",postfixFontSize:"50%",thresholds:"",colorBackground:!1,colorValue:!1,colors:["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],sparkline:{show:!1,full:!1,lineColor:"rgb(31, 120, 193)",fillColor:"rgba(31, 118, 189, 0.18)"}};c.defaults(a.panel,h),a.unitFormats=d.getUnitFormats(),a.setUnitFormat=function(b){a.panel.format=b.value,a.render()},a.init=function(){b.init(a)},a.refreshData=function(b){return g.updateTimeRange(a),g.issueMetricQuery(a,b).then(a.dataHandler,function(b){throw a.series=[],a.render(),b})},a.loadSnapshot=function(b){g.updateTimeRange(a),a.dataHandler(b)},a.dataHandler=function(b){a.series=c.map(b.data,a.seriesHandler),a.render()},a.seriesHandler=function(b){var c=new e({datapoints:b.datapoints,alias:b.target});return c.flotpairs=c.getFlotPairs(a.panel.nullPointMode),c},a.setColoring=function(b){b.background?(a.panel.colorValue=!1,a.panel.colors=["rgba(71, 212, 59, 0.4)","rgba(245, 150, 40, 0.73)","rgba(225, 40, 40, 0.59)"]):(a.panel.colorBackground=!1,a.panel.colors=["rgba(50, 172, 45, 0.97)","rgba(237, 129, 40, 0.89)","rgba(245, 54, 54, 0.9)"]),a.render()},a.invertColorOrder=function(){var b=a.panel.colors[0];a.panel.colors[0]=a.panel.colors[2],a.panel.colors[2]=b,a.render()},a.getDecimalsForValue=function(b){if(c.isNumber(a.panel.decimals))return{decimals:a.panel.decimals,scaledDecimals:null};var d,e=b/2,f=-Math.floor(Math.log(e)/Math.LN10),g=Math.pow(10,-f),h=e/g;1.5>h?d=1:3>h?(d=2,h>2.25&&(d=2.5,++f)):d=7.5>h?5:10,d*=g,Math.floor(b)===b&&(f=0);var i={};return i.decimals=Math.max(0,f),i.scaledDecimals=i.decimals-Math.floor(Math.log(d)/Math.LN10)+2,i},a.render=function(){var b={};a.setValues(b),b.thresholds=a.panel.thresholds.split(",").map(function(a){return Number(a.trim())}),b.colorMap=a.panel.colors,a.data=b,a.$broadcast("render")},a.setValues=function(b){if(b.flotpairs=[],a.series.length>1)throw a.inspector.error=new Error,a.inspector.error.message="Multiple Series Error",a.inspector.error.data="Metric query returns "+a.series.length+" series. Single Stat Panel expects a single series.\n\nResponse:\n"+JSON.stringify(a.series),a.inspector.error;if(a.series&&a.series.length>0){var e=c.last(a.series[0].datapoints),f=c.isArray(e)?e[0]:null;if(c.isString(f))b.value=0,b.valueFormated=f,b.valueRounded=0;else{b.value=a.series[0].stats[a.panel.valueName],b.flotpairs=a.series[0].flotpairs;var g=a.getDecimalsForValue(b.value),h=d.valueFormats[a.panel.format];b.valueFormated=h(b.value,g.decimals,g.scaledDecimals),b.valueRounded=d.roundValue(b.value,g.decimals)}}for(var i=0;i<a.panel.valueMaps.length;i++){var j=a.panel.valueMaps[i];if("null"!==j.value){var k=parseFloat(j.value);if(k===b.value)return void(b.valueFormated=j.text)}else if(null===b.value||void 0===b.value)return void(b.valueFormated=j.text)}(null===b.value||void 0===b.value)&&(b.valueFormated="no value")},a.removeValueMap=function(b){var d=c.indexOf(a.panel.valueMaps,b);a.panel.valueMaps.splice(d,1),a.render()},a.addValueMap=function(){a.panel.valueMaps.push({value:"",op:"=",text:""})},a.init()}])});