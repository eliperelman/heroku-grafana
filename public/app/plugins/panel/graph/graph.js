/*! grafana - v3.1.1-1470047149 - 2016-08-01
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","jquery","moment","lodash","app/core/utils/kbn","./graph_tooltip","jquery.flot","jquery.flot.selection","jquery.flot.time","jquery.flot.stack","jquery.flot.stackpercent","jquery.flot.fillbelow","jquery.flot.crosshair","./jquery.flot.events"],function(a,b,c,d,e,f){"use strict";var g=a.module("grafana.directives"),h={};g.directive("grafanaGraph",["$rootScope","timeSrv",function(a,g){return{restrict:"A",template:"<div> </div>",link:function(a,i){function j(a){if(!E.legend.show||E.legend.rightSide)return 0;if(E.legend.alignAsTable){var b=d.filter(z,function(a){return a.hideFromLegend(E.legend)===!1}),c=23+21*b.length;return Math.min(c,Math.floor(a/2))}return 26}function k(){try{var a=C.height-j(C.height);return i.css("height",a+"px"),!0}catch(b){return console.log(b),!1}}function l(){return!z||(!k()||(0===H||void 0))}function m(a,b){var c=h[a];return c||(c=h[a]=b.width()),c}function n(c){for(var f=c.getYAxes(),g=0;g<z.length;g++){var h=z[g],j=f[h.yaxis-1],k=e.valueFormats[E.yaxes[h.yaxis-1].format];if(d.isNumber(E.decimals))h.updateLegendValues(k,E.decimals,null);else{var l=(j.tickDecimals||-1)+1;h.updateLegendValues(k,l,j.scaledDecimals+2)}G.$$phase||a.$digest()}if(E.yaxes[0].label){var n=b("<div class='axisLabel left-yaxis-label'></div>").text(E.yaxes[0].label).appendTo(i);n[0].style.marginTop=m(E.yaxes[0].label,n)/2+"px"}if(E.yaxes[1].label){var o=b("<div class='axisLabel right-yaxis-label'></div>").text(E.yaxes[1].label).appendTo(i);o[0].style.marginTop=m(E.yaxes[1].label,o)/2+"px"}}function o(a,b){var c=E.yaxes[0],d=E.yaxes[1];c.show&&c.label&&(b.left=20),d.show&&d.label&&(b.right=20)}function p(){function a(a){try{b.plot(i,B,e)}catch(c){console.log("flotcharts error",c)}a&&C.renderingCompleted()}if(H=i.width(),!l()){for(var c=!!E.stack||null,e={hooks:{draw:[n],processOffset:[o]},legend:{show:!1},series:{stackpercent:!!E.stack&&E.percentage,stack:E.percentage?null:c,lines:{show:E.lines,zero:!1,fill:q(E.fill),lineWidth:E.linewidth,steps:E.steppedLine},bars:{show:E.bars,fill:1,barWidth:1,zero:!1,lineWidth:0},points:{show:E.points,fill:1,fillColor:!1,radius:E.points?E.pointradius:2},shadowSize:0},yaxes:[],xaxis:{},grid:{minBorderMargin:0,markings:[],backgroundColor:null,borderWidth:0,hoverable:!0,color:"#c8c8c8",margin:{left:0,right:0}},selection:{mode:"x",color:"#666"},crosshair:{mode:E.tooltip.shared||D.sharedCrosshair?"x":null}},f=0;f<z.length;f++){var g=z[f];g.data=g.getFlotPairs(g.nullPointMode||E.nullPointMode),C.hiddenSeries[g.alias]&&(g.data=[],g.stack=!1)}z.length&&z[0].stats.timeStep&&(e.series.bars.barWidth=z[0].stats.timeStep/1.5),s(e),t(e,E),u(e),v(z,e),B=d.sortBy(z,function(a){return a.zindex}),r(E)?(a(!1),setTimeout(function(){a(!0)},50),F=E.legend.rightSide):a(!0)}}function q(a){return 0===a?.001:a/10}function r(a){return!!a.legend.rightSide||(null!==F&&a.legend.rightSide!==F||void 0)}function s(a){var b=H/100,c=d.isUndefined(C.range.from)?null:C.range.from.valueOf(),e=d.isUndefined(C.range.to)?null:C.range.to.valueOf();a.xaxis={timezone:D.getTimezone(),show:E.xaxis.show,mode:"time",min:c,max:e,label:"Datetime",ticks:b,timeformat:y(b,c,e)}}function t(a,b){if(d.isNumber(b.grid.threshold1)){var c=b.grid.thresholdLine?b.grid.threshold1:b.grid.threshold2||null;if(a.grid.markings.push({yaxis:{from:b.grid.threshold1,to:c},color:b.grid.threshold1Color}),d.isNumber(b.grid.threshold2)){var e;e=b.grid.thresholdLine?b.grid.threshold2:b.grid.threshold1>b.grid.threshold2?-(1/0):+(1/0),a.grid.markings.push({yaxis:{from:b.grid.threshold2,to:e},color:b.grid.threshold2Color})}}}function u(a){if(A&&0!==A.length){var b={};d.each(A,function(a){b[a.annotation.name]||(b[a.annotation.name]={color:a.annotation.iconColor,position:"BOTTOM",markerSize:5})}),a.events={levels:d.keys(b).length+1,data:A,types:b}}}function v(a,b){var c={position:"left",show:E.yaxes[0].show,min:E.yaxes[0].min,index:1,logBase:E.yaxes[0].logBase||1,max:E.percentage&&E.stack?100:E.yaxes[0].max};if(b.yaxes.push(c),d.findWhere(a,{yaxis:2})){var e=d.clone(c);e.index=2,e.show=E.yaxes[1].show,e.logBase=E.yaxes[1].logBase||1,e.position="right",e.min=E.yaxes[1].min,e.max=E.percentage&&E.stack?100:E.yaxes[1].max,b.yaxes.push(e),w(b.yaxes[1],a),x(b.yaxes[1],E.percentage&&E.stack?"percent":E.yaxes[1].format)}w(b.yaxes[0],a),x(b.yaxes[0],E.percentage&&E.stack?"percent":E.yaxes[0].format)}function w(a,b){if(1!==a.logBase){var c,d,e=a.max;if(null===e){for(d=0;d<b.length;d++)c=b[d],c.yaxis===a.index&&e<c.stats.max&&(e=c.stats.max);void 0===e&&(e=Number.MAX_VALUE)}a.min=null!==a.min?a.min:0,a.ticks=[0,1];for(var f=1;;)if(f*=a.logBase,a.ticks.push(f),f>e)break;10===a.logBase?(a.transform=function(a){return Math.log(a+.1)},a.inverseTransform=function(a){return Math.pow(10,a)}):(a.transform=function(b){return Math.log(b+.1)/Math.log(a.logBase)},a.inverseTransform=function(b){return Math.pow(a.logBase,b)})}}function x(a,b){a.tickFormatter=function(a,c){return e.valueFormats[b](a,c.tickDecimals,c.scaledDecimals)}}function y(a,b,c){if(b&&c&&a){var d=c-b,e=d/a/1e3,f=864e5,g=31536e6;return e<=45?"%H:%M:%S":e<=7200||d<=f?"%H:%M":e<=8e4?"%m/%d %H:%M":e<=2419200||d<=g?"%m/%d":"%Y-%m"}return"%H:%M"}var z,A,B,C=a.ctrl,D=C.dashboard,E=C.panel,F=null,G=a.$root,H=0;G.onAppEvent("setCrosshair",function(b,c){if(c.scope!==a&&D.sharedCrosshair){var d=i.data().plot;d&&d.setCrosshair({x:c.pos.x,y:c.pos.y})}},a),G.onAppEvent("clearCrosshair",function(){var a=i.data().plot;a&&a.clearCrosshair()},a),C.events.on("render",function(a){return(z=a||z)?(A=z.annotations||A,void p()):void C.refresh()}),new f(i,D,a,function(){return B}),i.bind("plotselected",function(b,d){a.$apply(function(){g.setTime({from:c.utc(d.xaxis.from),to:c.utc(d.xaxis.to)})})})}}}])});