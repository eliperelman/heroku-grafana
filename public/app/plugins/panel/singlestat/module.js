/*! grafana - v3.1.1-1470047149 - 2016-08-01
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["lodash","jquery","jquery.flot","jquery.flot.gauge","app/core/utils/kbn","app/core/config","app/core/time_series2","app/plugins/sdk"],function(a){function b(a,b){for(var d=a.thresholds.length;d>0;d--)if(b>=a.thresholds[d-1])return a.colorMap[d];return c["default"].first(a.colorMap)}var c,d,e,f,g,h,i,j=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};return{setters:[function(a){c=a},function(a){d=a},function(a){},function(a){},function(a){e=a},function(a){f=a},function(a){g=a},function(a){h=a}],execute:function(){i=function(a){function h(b,d,e,f){a.call(this,b,d),this.$location=e,this.linkSrv=f,this.panelDefaults={links:[],datasource:null,maxDataPoints:100,interval:null,targets:[{}],cacheTimeout:null,format:"none",prefix:"",postfix:"",nullText:null,valueMaps:[{value:"null",op:"=",text:"N/A"}],mappingTypes:[{name:"value to text",value:1},{name:"range to text",value:2}],rangeMaps:[{from:"null",to:"null",text:"N/A"}],mappingType:1,nullPointMode:"connected",valueName:"avg",prefixFontSize:"50%",valueFontSize:"80%",postfixFontSize:"50%",thresholds:"",colorBackground:!1,colorValue:!1,colors:["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],sparkline:{show:!1,full:!1,lineColor:"rgb(31, 120, 193)",fillColor:"rgba(31, 118, 189, 0.18)"},gauge:{show:!1,minValue:0,maxValue:100,thresholdMarkers:!0,thresholdLabels:!1}},c["default"].defaults(this.panel,this.panelDefaults),this.events.on("data-received",this.onDataReceived.bind(this)),this.events.on("data-error",this.onDataError.bind(this)),this.events.on("data-snapshot-load",this.onDataReceived.bind(this)),this.events.on("init-edit-mode",this.onInitEditMode.bind(this))}return j(h,a),h.$inject=["$scope","$injector","$location","linkSrv"],h.prototype.onInitEditMode=function(){this.fontSizes=["20%","30%","50%","70%","80%","100%","110%","120%","150%","170%","200%"],this.addEditorTab("Options","public/app/plugins/panel/singlestat/editor.html",2),this.addEditorTab("Value Mappings","public/app/plugins/panel/singlestat/mappings.html",3),this.unitFormats=e["default"].getUnitFormats()},h.prototype.setUnitFormat=function(a){this.panel.format=a.value,this.render()},h.prototype.onDataError=function(a){this.onDataReceived([])},h.prototype.onDataReceived=function(a){this.series=a.map(this.seriesHandler.bind(this));var b={};this.setValues(b),this.data=b,this.render()},h.prototype.seriesHandler=function(a){var b=new g["default"]({datapoints:a.datapoints,alias:a.target});return b.flotpairs=b.getFlotPairs(this.panel.nullPointMode),b},h.prototype.setColoring=function(a){a.background?(this.panel.colorValue=!1,this.panel.colors=["rgba(71, 212, 59, 0.4)","rgba(245, 150, 40, 0.73)","rgba(225, 40, 40, 0.59)"]):(this.panel.colorBackground=!1,this.panel.colors=["rgba(50, 172, 45, 0.97)","rgba(237, 129, 40, 0.89)","rgba(245, 54, 54, 0.9)"]),this.render()},h.prototype.invertColorOrder=function(){var a=this.panel.colors[0];this.panel.colors[0]=this.panel.colors[2],this.panel.colors[2]=a,this.render()},h.prototype.getDecimalsForValue=function(a){if(c["default"].isNumber(this.panel.decimals))return{decimals:this.panel.decimals,scaledDecimals:null};var b,d=a/2,e=-Math.floor(Math.log(d)/Math.LN10),f=Math.pow(10,-e),g=d/f;g<1.5?b=1:g<3?(b=2,g>2.25&&(b=2.5,++e)):b=g<7.5?5:10,b*=f,Math.floor(a)===a&&(e=0);var h={};return h.decimals=Math.max(0,e),h.scaledDecimals=h.decimals-Math.floor(Math.log(b)/Math.LN10)+2,h},h.prototype.setValues=function(a){if(a.flotpairs=[],this.series.length>1){var b=new Error;throw b.message="Multiple Series Error",b.data="Metric query returns "+this.series.length+" series. Single Stat Panel expects a single series.\n\nResponse:\n"+JSON.stringify(this.series),b}if(this.series&&this.series.length>0){var d=c["default"].last(this.series[0].datapoints),f=c["default"].isArray(d)?d[0]:null;if(c["default"].isString(f))a.value=0,a.valueFormated=f,a.valueRounded=0;else{a.value=this.series[0].stats[this.panel.valueName],a.flotpairs=this.series[0].flotpairs;var g=this.getDecimalsForValue(a.value),h=e["default"].valueFormats[this.panel.format];a.valueFormated=h(a.value,g.decimals,g.scaledDecimals),a.valueRounded=e["default"].roundValue(a.value,g.decimals)}}if(1===this.panel.mappingType)for(var i=0;i<this.panel.valueMaps.length;i++){var j=this.panel.valueMaps[i];if("null"!==j.value){var k=parseFloat(j.value);if(k===a.valueRounded)return void(a.valueFormated=j.text)}else if(null===a.value||void 0===a.value)return void(a.valueFormated=j.text)}else if(2===this.panel.mappingType)for(var i=0;i<this.panel.rangeMaps.length;i++){var j=this.panel.rangeMaps[i];if("null"!==j.from||"null"!==j.to){var l=parseFloat(j.from),m=parseFloat(j.to);if(m>=a.valueRounded&&l<=a.valueRounded)return void(a.valueFormated=j.text)}else if(null===a.value||void 0===a.value)return void(a.valueFormated=j.text)}null!==a.value&&void 0!==a.value||(a.valueFormated="no value")},h.prototype.removeValueMap=function(a){var b=c["default"].indexOf(this.panel.valueMaps,a);this.panel.valueMaps.splice(b,1),this.render()},h.prototype.addValueMap=function(){this.panel.valueMaps.push({value:"",op:"=",text:""})},h.prototype.removeRangeMap=function(a){var b=c["default"].indexOf(this.panel.rangeMaps,a);this.panel.rangeMaps.splice(b,1),this.render()},h.prototype.addRangeMap=function(){this.panel.rangeMaps.push({from:"",to:"",text:""})},h.prototype.link=function(a,c,e,g){function h(){c.css("height",g.height+"px")}function i(a,c){if(!v.colorValue)return c;var d=b(q,a);return d?'<span style="color:'+d+'">'+c+"</span>":c}function j(a,b,c){return c=w.replace(c),'<span class="'+a+'" style="font-size:'+b+'">'+c+"</span>"}function k(){var a='<div class="singlestat-panel-value-container">';v.prefix&&(a+=j("singlestat-panel-prefix",v.prefixFontSize,v.prefix));var b=i(q.value,q.valueFormated);return a+=j("singlestat-panel-value",v.valueFontSize,b),v.postfix&&(a+=j("singlestat-panel-postfix",v.postfixFontSize,v.postfix)),a+="</div>"}function l(){var a=v.prefix?v.prefix:"";return a+=q.valueFormated,a+=v.postfix?v.postfix:""}function m(){var a=c.width(),e=c.height();if(g.invalidGaugeRange=!1,v.gauge.minValue>v.gauge.maxValue)return void(g.invalidGaugeRange=!0);var h=d["default"]("<div></div>"),i={top:"10px",margin:"auto",position:"relative",height:.9*e+"px",width:a+"px"};h.css(i);for(var j=[],k=0;k<q.thresholds.length;k++)j.push({value:q.thresholds[k],color:q.colorMap[k]});j.push({value:v.gauge.maxValue,color:q.colorMap[q.colorMap.length-1]});var m=f["default"].bootData.user.lightTheme?"rgb(230,230,230)":"rgb(38,38,38)",n=parseInt(v.valueFontSize)/100,o=Math.min(a,e),p=Math.min(o/5,100)*n,r=Math.min(o/6,60),s=r/5,t={series:{gauges:{gauge:{min:v.gauge.minValue,max:v.gauge.maxValue,background:{color:m},border:{color:null},shadow:{show:!1},width:r},frame:{show:!1},label:{show:!1},layout:{margin:0,thresholdWidth:0},cell:{border:{width:0}},threshold:{values:j,label:{show:v.gauge.thresholdLabels,margin:8,font:{size:18}},show:v.gauge.thresholdMarkers,width:s},value:{color:v.colorValue?b(q,q.valueRounded):null,formatter:function(){return l()},font:{size:p,family:'Helvetica Neue", Helvetica, Arial, sans-serif'}},show:!0}}};c.append(h);var u={data:[[0,q.valueRounded]]};d["default"].plot(h,[u],t)}function n(){var a=c.width()+20;if(a<30)return void setTimeout(n,30);var b=g.height,e=d["default"]("<div></div>"),f={};if(f.position="absolute",v.sparkline.full){f.bottom="5px",f.left="-5px",f.width=a-10+"px";var h=b<=100?5:15*Math.round(b/100)+5;f.height=b-h+"px"}else f.bottom="0px",f.left="-5px",f.width=a-10+"px",f.height=Math.floor(.25*b)+"px";e.css(f);var i={legend:{show:!1},series:{lines:{show:!0,fill:1,lineWidth:1,fillColor:v.sparkline.fillColor}},yaxes:{show:!1},xaxis:{show:!1,mode:"time",min:g.range.from.valueOf(),max:g.range.to.valueOf()},grid:{hoverable:!1,show:!1}};c.append(e);var j={data:q.flotpairs,color:v.sparkline.lineColor};d["default"].plot(e,[j],i)}function o(){if(g.data){q=g.data,q.thresholds=v.thresholds.split(",").map(function(a){return Number(a.trim())}),q.colorMap=v.colors,h();var d=v.gauge.show?"":k();if(v.colorBackground&&!isNaN(q.valueRounded)){var e=b(q,q.valueRounded);e&&(x.css("background-color",e),a.fullscreen?c.css("background-color",e):c.css("background-color",""))}else x.css("background-color",""),c.css("background-color","");c.html(d),v.sparkline.show&&n(),v.gauge.show&&m(),c.toggleClass("pointer",v.links.length>0),r=v.links.length>0?t.getPanelLinkAnchorInfo(v.links[0],v.scopedVars):null}}function p(){var a=d["default"]('<div id="tooltip" class="">hello</div>"');c.mouseleave(function(){0!==v.links.length&&a.detach()}),c.click(function(b){if(r&&!(d["default"](b).parents(".panel-header").length>0)){if("_blank"===r.target){var c=window.open(r.href,"_blank");return void c.location}0===r.href.indexOf("http")?window.location.href=r.href:u(function(){s.url(r.href)}),a.detach()}}),c.mousemove(function(b){r&&(a.text("click to go to: "+r.title),a.place_tt(b.pageX+20,b.pageY-15))})}var q,r,s=this.$location,t=this.linkSrv,u=this.$timeout,v=g.panel,w=this.templateSrv,x=c.find(".panel-container");c=c.find(".singlestat-panel"),p(),this.events.on("render",function(){o(),g.renderingCompleted()})},h.templateUrl="module.html",h}(h.MetricsPanelCtrl),a("SingleStatCtrl",i),a("PanelCtrl",i),a("getColorForValue",b)}}});