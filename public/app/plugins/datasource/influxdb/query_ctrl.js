/*! grafana - v4.0.0-1478693311beta1 - 2016-11-09
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["angular","lodash","./query_builder","./influx_query","./query_part","app/plugins/sdk"],function(a){var b,c,d,e,f,g,h,i=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};return{setters:[function(a){b=a},function(a){c=a},function(a){d=a},function(a){e=a},function(a){f=a},function(a){g=a}],execute:function(){h=function(a){function g(b,c,f,g,h){a.call(this,b,c),this.templateSrv=f,this.$q=g,this.uiSegmentSrv=h,this.target=this.target,this.queryModel=new e["default"](this.target,f,this.panel.scopedVars),this.queryBuilder=new d["default"](this.target,this.datasource.database),this.groupBySegment=this.uiSegmentSrv.newPlusButton(),this.resultFormats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],this.policySegment=h.newSegment(this.target.policy),this.target.measurement?this.measurementSegment=h.newSegment(this.target.measurement):this.measurementSegment=h.newSelectMeasurement(),this.tagSegments=[];for(var i=0,j=this.target.tags;i<j.length;i++){var k=j[i];k.operator||(/^\/.*\/$/.test(k.value)?k.operator="=~":k.operator="="),k.condition&&this.tagSegments.push(h.newCondition(k.condition)),this.tagSegments.push(h.newKey(k.key)),this.tagSegments.push(h.newOperator(k.operator)),this.tagSegments.push(h.newKeyValue(k.value))}this.fixTagSegments(),this.buildSelectMenu(),this.removeTagFilterSegment=h.newSegment({fake:!0,value:"-- remove tag filter --"})}return i(g,a),g.$inject=["$scope","$injector","templateSrv","$q","uiSegmentSrv"],g.prototype.buildSelectMenu=function(){var a=f["default"].getCategories();this.selectMenu=c["default"].reduce(a,function(a,b,c){var d={text:c,submenu:b.map(function(a){return{text:a.type,value:a.type}})};return a.push(d),a},[])},g.prototype.getGroupByOptions=function(){var a=this,b=this.queryBuilder.buildExploreQuery("TAG_KEYS");return this.datasource.metricFindQuery(b).then(function(b){var c=[];a.queryModel.hasFill()||c.push(a.uiSegmentSrv.newSegment({value:"fill(null)"})),a.queryModel.hasGroupByTime()||c.push(a.uiSegmentSrv.newSegment({value:"time($interval)"}));for(var d=0;d<b.length;d++){var e=b[d];c.push(a.uiSegmentSrv.newSegment({value:"tag("+e.text+")"}))}return c})["catch"](this.handleQueryError.bind(this))},g.prototype.groupByAction=function(){this.queryModel.addGroupBy(this.groupBySegment.value);var a=this.uiSegmentSrv.newPlusButton();this.groupBySegment.value=a.value,this.groupBySegment.html=a.html,this.panelCtrl.refresh()},g.prototype.addSelectPart=function(a,b,c){this.queryModel.addSelectPart(a,c.value),this.panelCtrl.refresh()},g.prototype.handleSelectPartEvent=function(a,b,c){switch(c.name){case"get-param-options":var d=this.queryBuilder.buildExploreQuery("FIELDS");return this.datasource.metricFindQuery(d).then(this.transformToSegments(!0))["catch"](this.handleQueryError.bind(this));case"part-param-changed":this.panelCtrl.refresh();break;case"action":this.queryModel.removeSelectPart(a,b),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},g.prototype.handleGroupByPartEvent=function(a,b,c){switch(c.name){case"get-param-options":var d=this.queryBuilder.buildExploreQuery("TAG_KEYS");return this.datasource.metricFindQuery(d).then(this.transformToSegments(!0))["catch"](this.handleQueryError.bind(this));case"part-param-changed":this.panelCtrl.refresh();break;case"action":this.queryModel.removeGroupByPart(a,b),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},g.prototype.fixTagSegments=function(){var a=this.tagSegments.length,b=this.tagSegments[Math.max(a-1,0)];b&&"plus-button"===b.type||this.tagSegments.push(this.uiSegmentSrv.newPlusButton())},g.prototype.measurementChanged=function(){this.target.measurement=this.measurementSegment.value,this.panelCtrl.refresh()},g.prototype.getPolicySegments=function(){var a=this.queryBuilder.buildExploreQuery("RETENTION POLICIES");return this.datasource.metricFindQuery(a).then(this.transformToSegments(!1))["catch"](this.handleQueryError.bind(this))},g.prototype.policyChanged=function(){this.target.policy=this.policySegment.value,this.panelCtrl.refresh()},g.prototype.toggleEditorMode=function(){try{this.target.query=this.queryModel.render(!1)}catch(a){console.log("query render error")}this.target.rawQuery=!this.target.rawQuery},g.prototype.getMeasurements=function(a){var b=this.queryBuilder.buildExploreQuery("MEASUREMENTS",void 0,a);return this.datasource.metricFindQuery(b).then(this.transformToSegments(!0))["catch"](this.handleQueryError.bind(this))},g.prototype.handleQueryError=function(a){return this.error=a.message||"Failed to issue metric query",[]},g.prototype.transformToSegments=function(a){var b=this;return function(d){var e=c["default"].map(d,function(a){return b.uiSegmentSrv.newSegment({value:a.text,expandable:a.expandable})});if(a)for(var f=0,g=b.templateSrv.variables;f<g.length;f++){var h=g[f];e.unshift(b.uiSegmentSrv.newSegment({type:"template",value:"/^$"+h.name+"$/",expandable:!0}))}return e}},g.prototype.getTagsOrValues=function(a,c){var d=this;if("condition"===a.type)return this.$q.when([this.uiSegmentSrv.newSegment("AND"),this.uiSegmentSrv.newSegment("OR")]);if("operator"===a.type){var e=this.tagSegments[c+1].value;return/^\/.*\/$/.test(e)?this.$q.when(this.uiSegmentSrv.newOperators(["=~","!~"])):this.$q.when(this.uiSegmentSrv.newOperators(["=","!=","<>","<",">"]))}var f,g;return"key"===a.type||"plus-button"===a.type?(f=this.queryBuilder.buildExploreQuery("TAG_KEYS"),g=!1):"value"===a.type&&(f=this.queryBuilder.buildExploreQuery("TAG_VALUES",this.tagSegments[c-2].value),g=!0),this.datasource.metricFindQuery(f).then(this.transformToSegments(g)).then(function(c){return"key"===a.type&&c.splice(0,0,b["default"].copy(d.removeTagFilterSegment)),c})["catch"](this.handleQueryError.bind(this))},g.prototype.getFieldSegments=function(){var a=this.queryBuilder.buildExploreQuery("FIELDS");return this.datasource.metricFindQuery(a).then(this.transformToSegments(!1))["catch"](this.handleQueryError)},g.prototype.tagSegmentUpdated=function(a,b){this.tagSegments[b]=a,a.value===this.removeTagFilterSegment.value?(this.tagSegments.splice(b,3),0===this.tagSegments.length?this.tagSegments.push(this.uiSegmentSrv.newPlusButton()):this.tagSegments.length>2&&(this.tagSegments.splice(Math.max(b-1,0),1),"plus-button"!==this.tagSegments[this.tagSegments.length-1].type&&this.tagSegments.push(this.uiSegmentSrv.newPlusButton()))):("plus-button"===a.type&&(b>2&&this.tagSegments.splice(b,0,this.uiSegmentSrv.newCondition("AND")),this.tagSegments.push(this.uiSegmentSrv.newOperator("=")),this.tagSegments.push(this.uiSegmentSrv.newFake("select tag value","value","query-segment-value")),a.type="key",a.cssClass="query-segment-key"),b+1===this.tagSegments.length&&this.tagSegments.push(this.uiSegmentSrv.newPlusButton())),this.rebuildTargetTagConditions()},g.prototype.rebuildTargetTagConditions=function(){var a=this,b=[],d=0,e="";c["default"].each(this.tagSegments,function(c,f){"key"===c.type?(0===b.length&&b.push({}),b[d].key=c.value):"value"===c.type?(e=a.getTagValueOperator(c.value,b[d].operator),e&&(a.tagSegments[f-1]=a.uiSegmentSrv.newOperator(e),b[d].operator=e),b[d].value=c.value):"condition"===c.type?(b.push({condition:c.value}),d+=1):"operator"===c.type&&(b[d].operator=c.value)}),this.target.tags=b,this.panelCtrl.refresh()},g.prototype.getTagValueOperator=function(a,b){return"=~"!==b&&"!~"!==b&&/^\/.*\/$/.test(a)?"=~":"=~"!==b&&"!~"!==b||!/^(?!\/.*\/$)/.test(a)?void 0:"="},g.prototype.getCollapsedText=function(){return this.queryModel.render(!1)},g.templateUrl="partials/query.editor.html",g}(g.QueryCtrl),a("InfluxQueryCtrl",h)}}});