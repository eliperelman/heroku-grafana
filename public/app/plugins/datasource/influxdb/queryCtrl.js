/*! grafana - v2.2.0-pre1 - 2015-09-02
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","./queryBuilder"],function(a,b,c){"use strict";var d=a.module("grafana.controllers");d.controller("InfluxQueryCtrl",["$scope","$timeout","$sce","templateSrv","$q",function(d,e,f,g,h){function i(a){return"*"===a||"*"===a.value?(this.value="*",this.html=f.trustAsHtml('<i class="fa fa-asterisk"><i>'),void(this.expandable=!0)):b.isString(a)?(this.value=a,void(this.html=f.trustAsHtml(this.value))):(this.cssClass=a.cssClass,this.type=a.type,this.fake=a.fake,this.value=a.value,this.type=a.type,this.expandable=a.expandable,void(this.html=a.html||f.trustAsHtml(g.highlightVariablesAsHtml(this.value))))}d.init=function(){if(d.target){var a=d.target;a.tags=a.tags||[],a.groupByTags=a.groupByTags||[],a.fields=a.fields||[{name:"value",func:a["function"]||"mean"}],d.queryBuilder=new c(a),d.measurementSegment=a.measurement?new i(a.measurement):i.newSelectMeasurement(),d.addFieldSegment=i.newPlusButton(),d.tagSegments=[],b.each(a.tags,function(a){a.operator||(a.operator=/^\/.*\/$/.test(a.value)?"=~":"="),a.condition&&d.tagSegments.push(i.newCondition(a.condition)),d.tagSegments.push(new i({value:a.key,type:"key",cssClass:"query-segment-key"})),d.tagSegments.push(i.newOperator(a.operator)),d.tagSegments.push(new i({value:a.value,type:"value",cssClass:"query-segment-value"}))}),d.fixTagSegments(),d.groupBySegments=[],b.each(a.groupByTags,function(a){d.groupBySegments.push(new i(a))}),d.groupBySegments.push(i.newPlusButton()),d.removeTagFilterSegment=new i({fake:!0,value:"-- remove tag filter --"}),d.removeGroupBySegment=new i({fake:!0,value:"-- remove group by --"})}},d.fixTagSegments=function(){var a=d.tagSegments.length,b=d.tagSegments[Math.max(a-1,0)];b&&"plus-button"===b.type||d.tagSegments.push(i.newPlusButton())},d.groupByTagUpdated=function(a,b){return a.value===d.removeGroupBySegment.value?(d.target.groupByTags.splice(b,1),d.groupBySegments.splice(b,1),void d.$parent.get_data()):(b===d.groupBySegments.length-1&&d.groupBySegments.push(i.newPlusButton()),a.type="group-by-key",a.fake=!1,d.target.groupByTags[b]=a.value,void d.$parent.get_data())},d.changeFunction=function(a){d.target["function"]=a,d.$parent.get_data()},d.measurementChanged=function(){d.target.measurement=d.measurementSegment.value,d.$parent.get_data()},d.getFields=function(){var a=d.queryBuilder.buildExploreQuery("FIELDS");return d.datasource.metricFindQuery(a).then(function(a){var c=b.pluck(a,"text");return d.target.fields.length>1&&c.splice(0,0,"-- remove from select --"),c})},d.toggleQueryMode=function(){d.target.rawQuery=!d.target.rawQuery},d.getMeasurements=function(){var a=d.queryBuilder.buildExploreQuery("MEASUREMENTS");return d.datasource.metricFindQuery(a).then(d.transformToSegments(!0)).then(null,d.handleQueryError)},d.handleQueryError=function(a){return d.parserError=a.message||"Failed to issue metric query",[]},d.transformToSegments=function(a){return function(c){var d=b.map(c,function(a){return new i({value:a.text,expandable:a.expandable})});return a&&b.each(g.variables,function(a){d.unshift(new i({type:"template",value:"/$"+a.name+"/",expandable:!0}))}),d}},d.getTagsOrValues=function(b,c){if("condition"===b.type)return h.when([new i("AND"),new i("OR")]);if("operator"===b.type){var e=d.tagSegments[c+1].value;return h.when(/^\/.*\/$/.test(e)?i.newOperators(["=~","!~"]):i.newOperators(["=","<>","<",">"]))}var f,g;return"key"===b.type||"plus-button"===b.type?(f=d.queryBuilder.buildExploreQuery("TAG_KEYS"),g=!1):"value"===b.type&&(f=d.queryBuilder.buildExploreQuery("TAG_VALUES",d.tagSegments[c-2].value),g=!0),d.datasource.metricFindQuery(f).then(d.transformToSegments(g)).then(function(c){return"key"===b.type&&c.splice(0,0,a.copy(d.removeTagFilterSegment)),c}).then(null,d.handleQueryError)},d.getFieldSegments=function(){var a=d.queryBuilder.buildExploreQuery("FIELDS");return d.datasource.metricFindQuery(a).then(d.transformToSegments(!1)).then(null,d.handleQueryError)},d.addField=function(){d.target.fields.push({name:d.addFieldSegment.value,func:"mean"}),b.extend(d.addFieldSegment,i.newPlusButton())},d.fieldChanged=function(a){"-- remove from select --"===a.name&&(d.target.fields=b.without(d.target.fields,a)),d.get_data()},d.getGroupByTagSegments=function(b){var c=d.queryBuilder.buildExploreQuery("TAG_KEYS");return d.datasource.metricFindQuery(c).then(d.transformToSegments(!1)).then(function(c){return"plus-button"!==b.type&&c.splice(0,0,a.copy(d.removeGroupBySegment)),c}).then(null,d.handleQueryError)},d.tagSegmentUpdated=function(a,b){d.tagSegments[b]=a,a.value===d.removeTagFilterSegment.value?(d.tagSegments.splice(b,3),0===d.tagSegments.length?d.tagSegments.push(i.newPlusButton()):d.tagSegments.length>2&&(d.tagSegments.splice(Math.max(b-1,0),1),"plus-button"!==d.tagSegments[d.tagSegments.length-1].type&&d.tagSegments.push(i.newPlusButton()))):("plus-button"===a.type&&(b>2&&d.tagSegments.splice(b,0,i.newCondition("AND")),d.tagSegments.push(i.newOperator("=")),d.tagSegments.push(i.newFake("select tag value","value","query-segment-value")),a.type="key",a.cssClass="query-segment-key"),b+1===d.tagSegments.length&&d.tagSegments.push(i.newPlusButton())),d.rebuildTargetTagConditions()},d.rebuildTargetTagConditions=function(){var a=[],c=0,e="";b.each(d.tagSegments,function(b,f){"key"===b.type?(0===a.length&&a.push({}),a[c].key=b.value):"value"===b.type?(e=d.getTagValueOperator(b.value,a[c].operator),e&&(d.tagSegments[f-1]=i.newOperator(e),a[c].operator=e),a[c].value=b.value):"condition"===b.type?(a.push({condition:b.value}),c+=1):"operator"===b.type&&(a[c].operator=b.value)}),d.target.tags=a,d.$parent.get_data()},d.getTagValueOperator=function(a,b){return"=~"!==b&&"!~"!==b&&/^\/.*\/$/.test(a)?"=~":"=~"!==b&&"!~"!==b||!/^(?!\/.*\/$)/.test(a)?void 0:"="},i.newSelectMeasurement=function(){return new i({value:"select measurement",fake:!0})},i.newFake=function(a,b,c){return new i({value:a,fake:!0,type:b,cssClass:c})},i.newCondition=function(a){return new i({value:a,type:"condition",cssClass:"query-keyword"})},i.newOperator=function(a){return new i({value:a,type:"operator",cssClass:"query-segment-operator"})},i.newOperators=function(a){return b.map(a,function(a){return new i({value:a,type:"operator",cssClass:"query-segment-operator"})})},i.newPlusButton=function(){return new i({fake:!0,html:'<i class="fa fa-plus "></i>',type:"plus-button"})},i.newSelectTagValue=function(){return new i({value:"select tag value",fake:!0})},d.init()}])});