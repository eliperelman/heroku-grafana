/*! grafana - v2.2.0-pre1 - 2015-09-02
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","kbn"],function(a,b,c){"use strict";var d=a.module("grafana.controllers");d.controller("OpenTSDBQueryCtrl",["$scope",function(d){function e(a){var d={};if(a.shouldDownsample)try{a.downsampleInterval?c.describe_interval(a.downsampleInterval):d.downsampleInterval="You must supply a downsample interval (e.g. '1m' or '1h')."}catch(e){d.downsampleInterval=e.message}return a.tags&&b.has(a.tags,a.currentTagKey)&&(d.tags="Duplicate tag key '"+a.currentTagKey+"'."),d}d.init=function(){d.target.errors=e(d.target),d.aggregators=["avg","sum","min","max","dev","zimsum","mimmin","mimmax"],d.target.aggregator||(d.target.aggregator="sum"),d.target.downsampleAggregator||(d.target.downsampleAggregator="avg")},d.targetBlur=function(){d.target.errors=e(d.target),!b.isEqual(d.oldTarget,d.target)&&b.isEmpty(d.target.errors)&&(d.oldTarget=a.copy(d.target),d.get_data())},d.getTextValues=function(a){return b.map(a,function(a){return a.text})},d.suggestMetrics=function(a,b){d.datasource.metricFindQuery("metrics("+a+")").then(d.getTextValues).then(b)},d.suggestTagKeys=function(a,b){d.datasource.metricFindQuery("tag_names("+d.target.metric+")").then(d.getTextValues).then(b)},d.suggestTagValues=function(a,b){d.datasource.metricFindQuery("tag_values("+d.target.metric+","+d.target.currentTagKey+")").then(d.getTextValues).then(b)},d.addTag=function(){return d.addTagMode?(d.target.tags||(d.target.tags={}),d.target.errors=e(d.target),d.target.errors.tags||(d.target.tags[d.target.currentTagKey]=d.target.currentTagValue,d.target.currentTagKey="",d.target.currentTagValue="",d.targetBlur()),void(d.addTagMode=!1)):void(d.addTagMode=!0)},d.removeTag=function(a){delete d.target.tags[a],d.targetBlur()},d.init()}])});