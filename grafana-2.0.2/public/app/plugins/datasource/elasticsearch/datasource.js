/*! grafana - v2.0.2 - 2015-04-22
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache License */

define(["angular","lodash","config","kbn","moment"],function(a,b,c,d,e){"use strict";var f=a.module("grafana.services");f.factory("ElasticDatasource",["$q","backendSrv","templateSrv",function(f,g,h){function i(a){this.type="elasticsearch",this.basicAuth=a.basicAuth,this.url=a.url,this.name=a.name,this.index=a.index,this.searchMaxResults=c.search.max_results||20,this.saveTemp=b.isUndefined(a.save_temp)?!0:a.save_temp,this.saveTempTTL=b.isUndefined(a.save_temp_ttl)?"30d":a.save_temp_ttl}return i.prototype._request=function(a,b,c,d){var e={url:this.url+"/"+c+b,method:a,data:d};return this.basicAuth&&(e.withCredentials=!0,e.headers={Authorization:this.basicAuth}),g.datasourceRequest(e)},i.prototype._get=function(a){return this._request("GET",a,this.index).then(function(a){return a.data})},i.prototype._post=function(a,b){return this._request("POST",a,this.index,b).then(function(a){return a.data})},i.prototype.annotationQuery=function(a,c){var d={},f=a.timeField||"@timestamp",g=a.query||"*",i=a.tagsField||"tags",j=a.titleField||"desc",k=a.textField||null;d[f]={from:c.from,to:c.to};var l=h.replace(g),m={bool:{must:[{range:d}]}},n={bool:{should:[{query_string:{query:l}}]}},o={fields:[f,"_source"],query:{filtered:{query:n,filter:m}},size:1e4};return this._request("POST","/_search",a.index,o).then(function(c){for(var d=[],g=c.data.hits.hits,h=function(a,c){if(c){for(var d=c.split("."),e=a,f=0;f<d.length;f++)if(e=e[d[f]],!e)return console.log("could not find field in annotatation: ",c),"";return b.isArray(e)&&(e=e.join(", ")),e}},l=0;l<g.length;l++){var m=g[l]._source,n=g[l].fields,o=m[f];(b.isString(n[f])||b.isNumber(n[f]))&&(o=n[f]);var p={annotation:a,time:e.utc(o).valueOf(),title:h(m,j),tags:h(m,i),text:h(m,k)};d.push(p)}return d})},i.prototype._getDashboardWithSlug=function(b){return this._get("/dashboard/"+d.slugifyForUrl(b)).then(function(b){return a.fromJson(b._source.dashboard)},function(){throw"Dashboard not found"})},i.prototype.getDashboard=function(b,c){var d="/dashboard/"+b;c&&(d="/temp/"+b);var e=this;return this._get(d).then(function(b){return a.fromJson(b._source.dashboard)},function(a){if(0===a.status)throw"Could not contact Elasticsearch. Please ensure that Elasticsearch is reachable from your browser.";return e._getDashboardWithSlug(b)})},i.prototype.saveDashboard=function(b){var c=b.title,e=b.temp;e&&delete b.temp;var f={user:"guest",group:"guest",title:c,tags:b.tags,dashboard:a.toJson(b)};if(e)return this._saveTempDashboard(f);var g=encodeURIComponent(d.slugifyForUrl(c)),h=this;return this._request("PUT","/dashboard/"+g,this.index,f).then(function(a){return h._removeUnslugifiedDashboard(a,c,g),{title:c,url:"/dashboard/db/"+g}},function(){throw"Failed to save to elasticsearch"})},i.prototype._removeUnslugifiedDashboard=function(a,b,c){if("Created"===a.statusText&&b!==c){var d=this;this._get("/dashboard/"+b).then(function(){d.deleteDashboard(b)})}},i.prototype._saveTempDashboard=function(a){return this._request("POST","/temp/?ttl="+this.saveTempTTL,this.index,a).then(function(b){var c=window.location.href.replace(window.location.hash,""),d=c+"#dashboard/temp/"+b.data._id;return{title:a.title,url:d}},function(a){throw"Failed to save to temp dashboard to elasticsearch "+a.data})},i.prototype.deleteDashboard=function(a){return this._request("DELETE","/dashboard/"+a,this.index).then(function(a){return a.data._id},function(a){throw a.data})},i.prototype.searchDashboards=function(a){var c=function(a,b,c){for(var d,e=0,f=0,g=a.length;g>f;f++)d=a[f],d===b?e++:d===c&&e--;return e>0},d=0===a.indexOf("tags!:");if(d){var e=a.substring(6,a.length);a="tags:"+e+"*"}else 0===a.length&&(a="title:"),a.match(/(\*|\]|}|~|\)|"|^\d+|\s[\-+]\w+)$/)||a.match(/[A-Z]$/)||c(a,"(",")")||c(a,'"','"')||c(a,"[","]")||c(a,"[","}")||c(a,"{","]")||c(a,"{","}")||(a+="*");var f={query:{query_string:{query:a}},facets:{tags:{terms:{field:"tags",order:"term",size:50}}},size:this.searchMaxResults,sort:["_uid"]};return this._post("/dashboard/_search",f).then(function(a){if(b.isUndefined(a.hits))return{dashboards:[],tags:[]};for(var c=a.hits.hits,e={dashboards:[],tags:a.facets.tags.terms||[]},f=0,g=c.length;g>f;f++){var h=c[f];e.dashboards.push({id:h._id,title:h._source.title,tags:h._source.tags})}return e.tagsOnly=d,e})},i}])});