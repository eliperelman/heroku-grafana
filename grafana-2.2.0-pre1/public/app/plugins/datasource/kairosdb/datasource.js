/*! grafana - v2.2.0-pre1 - 2015-09-02
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","kbn","./queryCtrl","./directives"],function(a,b,c){"use strict";var d=a.module("grafana.services");d.factory("KairosDBDatasource",["$q","backendSrv","templateSrv",function(d,e,f){function g(a){this.type=a.type,this.url=a.url,this.name=a.name,this.supportMetrics=!0}function h(a){if(a.data.errors&&!b.isEmpty(a.data.errors)){var c={message:a.data.errors[0]};return d.reject(c)}return d.reject(a)}function i(a,c){var d=[],e=0;return b.each(c.data.queries,function(c){b.each(c.results,function(c){var f=a[e].alias,g=" ( ";b.each(c.group_by,function(a){"tag"===a.name?b.each(a.group,function(a,b){g+=b+"="+a+" "}):"value"===a.name?g+="value_group="+a.group.group_number+" ":"time"===a.name&&(g+="time_group="+a.group.group_number+" ")}),g+=") "," ( ) "!==g&&(f+=g);for(var h=[],i=0;i<c.values.length;i++){var j=Math.floor(c.values[i][0]),k=c.values[i][1];h[i]=[k,j]}a[e].exouter&&(h=new m(h,10)),d.push({target:f,datapoints:h})}),e++}),{data:b.flatten(d)}}function j(c,d){if(!d.metric||d.hide)return null;var e={name:f.replace(d.metric)};return e.aggregators=[],"(NONE)"!==d.downsampling&&e.aggregators.push({name:d.downsampling,align_sampling:!0,align_start_time:!0,sampling:g.prototype.convertToKairosInterval(d.sampling||c.interval)}),d.horizontalAggregators&&b.each(d.horizontalAggregators,function(a){var b={name:a.name};a.sampling_rate&&(b.sampling=g.prototype.convertToKairosInterval(a.sampling_rate),b.align_sampling=!0,b.align_start_time=!0),a.unit&&(b.unit=a.unit+"s"),a.factor&&"div"===a.name?b.divisor=a.factor:a.factor&&"scale"===a.name&&(b.factor=a.factor),a.percentile&&(b.percentile=a.percentile),e.aggregators.push(b)}),b.isEmpty(e.aggregators)&&delete e.aggregators,d.tags&&(e.tags=a.copy(d.tags),b.forOwn(e.tags,function(a,c){e.tags[c]=b.map(a,function(a){return f.replace(a)})})),(d.groupByTags||d.nonTagGroupBys)&&(e.group_by=[],d.groupByTags&&e.group_by.push({name:"tag",tags:b.map(a.copy(d.groupByTags),function(a){return f.replace(a)})}),d.nonTagGroupBys&&b.each(d.nonTagGroupBys,function(b){var c=a.copy(b);"time"===c.name&&(c.range_size=g.prototype.convertToKairosInterval(c.range_size)),e.group_by.push(c)})),e}function k(a,d,e){var f;if(b.isString(a)){if("now"===a)return;if(a.indexOf("now-")>=0){a=a.substring(4),f=e+"_relative";var g=/(\d+)\s*(\D+)/,h=g.exec(a);if(h){var i=h[1],j=h[2];return void(d[f]={value:i,unit:l(j)})}return void console.log("Unparseable date",a)}a=c.parseDate(a)}return b.isDate(a)?(f=e+"_absolute",void(d[f]=a.getTime())):void console.log("Date is neither string nor date")}function l(a){switch(a){case"ms":return"milliseconds";case"s":return"seconds";case"m":return"minutes";case"h":return"hours";case"d":return"days";case"w":return"weeks";case"M":return"months";case"y":return"years";default:return console.log("Unknown unit ",a),""}}function m(a,b){var c=a,d=c.length;if(3>=d)return c;var e=d-1,f=Math.abs((c[1][0]-c[0][0])/c[0][0]),g=Math.abs((c[1][0]-c[2][0])/c[2][0]);f>=b&&b>g&&(c[0][0]=c[1][0]),f=Math.abs((c[e-1][0]-c[e-2][0])/c[e-2][0]),g=Math.abs((c[e-1][0]-c[e][0])/c[e][0]),f>=b&&b>g&&(c[e][0]=c[e-1][0]);for(var h=1;d-1>h;h++)f=Math.abs((c[h][0]-c[h-1][0])/c[h-1][0]),g=Math.abs((c[h][0]-c[h+1][0])/c[h+1][0]),f>=b&&g>=b&&(c[h][0]=(c[h-1][0]+c[h+1][0])/2);return c}return g.prototype.query=function(a){var c=a.range.from,e=a.range.to,f=b.compact(b.map(a.targets,b.partial(j,a))),g=b.compact(b.map(a.targets,function(a){var b=a.alias;return("undefined"==typeof a.alias||""===a.alias)&&(b=a.metric),a.hide?null:{alias:b,exouter:a.exOuter}})),k=b.partial(i,g);if(b.isEmpty(f)){var l=d.defer();return l.resolve({data:[]}),l.promise}return this.performTimeSeriesQuery(f,c,e).then(k,h)},g.prototype.performTimeSeriesQuery=function(a,b,c){var d={metrics:a,cache_time:0};k(b,d,"start"),k(c,d,"end");var f={method:"POST",url:this.url+"/api/v1/datapoints/query",data:d};return e.datasourceRequest(f)},g.prototype._performMetricSuggestQuery=function(a){var c={url:this.url+"/api/v1/metricnames",method:"GET"};return e.datasourceRequest(c).then(function(c){if(!c.data)return d.when([]);var e=[];return b.each(c.data.results,function(b){b.indexOf(a)>=0&&e.push(b)}),e})},g.prototype._performMetricKeyLookup=function(a){if(!a)return d.when([]);var c={method:"POST",url:this.url+"/api/v1/datapoints/query/tags",data:{metrics:[{name:a}],cache_time:0,start_absolute:0}};return e.datasourceRequest(c).then(function(a){if(!a.data)return d.when([]);var c=[];return b.each(a.data.queries[0].results[0].tags,function(a,b){-1===c.indexOf(b)&&c.push(b)}),c})},g.prototype._performMetricKeyValueLookup=function(a,b){if(!a||!b)return d.when([]);var c={method:"POST",url:this.url+"/api/v1/datapoints/query/tags",data:{metrics:[{name:a}],cache_time:0,start_absolute:0}};return e.datasourceRequest(c).then(function(a){return a.data?a.data.queries[0].results[0].tags[b]:d.when([])})},g.prototype.performTagSuggestQuery=function(a){var b={url:this.url+"/api/v1/datapoints/query/tags",method:"POST",data:{metrics:[{name:a}],cache_time:0,start_absolute:0}};return e.datasourceRequest(b).then(function(a){return a.data?a.data.queries[0].results[0]:[]})},g.prototype.metricFindQuery=function(a){if(!a)return d.when([]);var c;try{c=f.replace(a)}catch(e){return d.reject(e)}var g=function(a){return b.map(a,function(a){return{text:a}})},h=/metrics\((.*)\)/,i=/tag_names\((.*)\)/,j=/tag_values\((.*),\s?(.*?)\)/,k=c.match(h);if(k)return this._performMetricSuggestQuery(k[1]).then(g);var l=c.match(i);if(l)return this._performMetricKeyLookup(l[1]).then(g);var m=c.match(j);return m?this._performMetricKeyValueLookup(m[1],m[2]).then(g):d.when([])},g.prototype.convertToKairosInterval=function(a){a=f.replace(a);var b=/(\d+(?:\.\d+)?)([Mwdhmsy])/,d=/(\d+(?:\.\d+)?)(ms)/,e=a.match(d);if(e||(e=a.match(b)),!e)throw new Error('Invalid interval string, expecting a number followed by one of "y M w d h m s ms"');var g=e[1],h=e[2];if(g%1!==0){if("ms"===h)throw new Error("Invalid interval value, cannot be smaller than the millisecond");g=Math.round(c.intervals_in_seconds[h]*g*1e3),h="ms"}return{value:g,unit:l(h)}},g}])});